# src/services/clinical_analysis_service.py
"""
è¨ºç™‚å®Ÿç¸¾ãƒ»æ²»ç™‚æˆç¸¾åˆ†æã‚µãƒ¼ãƒ“ã‚¹
æ€¥æ€§å¿ƒç­‹æ¢—å¡ãªã©ã®ç–¾æ‚£åˆ¥æ²»ç™‚æˆç¸¾ã€ç—‡ä¾‹æ•°åˆ†æã‚’æä¾›
"""

import json
import os
from datetime import datetime
from langchain_openai import ChatOpenAI
from config import Config
from collections import defaultdict
import random

class ClinicalAnalysisService:
    def __init__(self):
        self.model = ChatOpenAI(
            model_name="gpt-4o-mini",
            openai_api_key=Config.OPENAI_API_KEY,
            temperature=0
        )
        self.clinical_data = self._generate_clinical_summary()
        
    def _generate_clinical_summary(self):
        """æ¨¡æ“¬çš„ãªè¨ºç™‚å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ"""
        return {
            "æ€¥æ€§å¿ƒç­‹æ¢—å¡": {
                "å¹´é–“ç—‡ä¾‹æ•°": 45,
                "å¹´é½¢åˆ¥": {
                    "50ä»£": {"ç—‡ä¾‹æ•°": 8, "å…¥é™¢æ—¥æ•°å¹³å‡": 12.3, "æ²»ç™‚æˆåŠŸç‡": 0.95},
                    "60ä»£": {"ç—‡ä¾‹æ•°": 18, "å…¥é™¢æ—¥æ•°å¹³å‡": 14.1, "æ²»ç™‚æˆåŠŸç‡": 0.92},
                    "70ä»£": {"ç—‡ä¾‹æ•°": 15, "å…¥é™¢æ—¥æ•°å¹³å‡": 16.8, "æ²»ç™‚æˆåŠŸç‡": 0.89},
                    "80ä»£ä»¥ä¸Š": {"ç—‡ä¾‹æ•°": 4, "å…¥é™¢æ—¥æ•°å¹³å‡": 19.2, "æ²»ç™‚æˆåŠŸç‡": 0.85}
                },
                "æ²»ç™‚æ–¹æ³•åˆ¥": {
                    "PCIï¼ˆçµŒçš®çš„å† å‹•è„ˆå½¢æˆè¡“ï¼‰": {"ç—‡ä¾‹æ•°": 38, "æˆåŠŸç‡": 0.94},
                    "å¤–ç§‘çš„æ²»ç™‚": {"ç—‡ä¾‹æ•°": 5, "æˆåŠŸç‡": 0.88},
                    "å†…ç§‘çš„æ²»ç™‚": {"ç—‡ä¾‹æ•°": 2, "æˆåŠŸç‡": 0.85}
                },
                "åˆä½µç—‡ç‡": 0.08,
                "30æ—¥æ­»äº¡ç‡": 0.04,
                "å†å…¥é™¢ç‡": 0.06
            },
            "è„³æ¢—å¡": {
                "å¹´é–“ç—‡ä¾‹æ•°": 62,
                "å¹´é½¢åˆ¥": {
                    "60ä»£": {"ç—‡ä¾‹æ•°": 14, "å…¥é™¢æ—¥æ•°å¹³å‡": 18.5, "æ²»ç™‚æˆåŠŸç‡": 0.87},
                    "70ä»£": {"ç—‡ä¾‹æ•°": 28, "å…¥é™¢æ—¥æ•°å¹³å‡": 22.3, "æ²»ç™‚æˆåŠŸç‡": 0.83},
                    "80ä»£ä»¥ä¸Š": {"ç—‡ä¾‹æ•°": 20, "å…¥é™¢æ—¥æ•°å¹³å‡": 26.1, "æ²»ç™‚æˆåŠŸç‡": 0.79}
                },
                "é‡ç—‡åº¦åˆ¥": {
                    "è»½ç—‡": {"ç—‡ä¾‹æ•°": 25, "å¹³å‡åœ¨é™¢æ—¥æ•°": 14.2},
                    "ä¸­ç­‰ç—‡": {"ç—‡ä¾‹æ•°": 28, "å¹³å‡åœ¨é™¢æ—¥æ•°": 24.6},
                    "é‡ç—‡": {"ç—‡ä¾‹æ•°": 9, "å¹³å‡åœ¨é™¢æ—¥æ•°": 38.4}
                }
            },
            "å¤§è…¿éª¨éª¨æŠ˜": {
                "å¹´é–“ç—‡ä¾‹æ•°": 78,
                "å¹´é½¢åˆ¥": {
                    "70ä»£": {"ç—‡ä¾‹æ•°": 32, "æ‰‹è¡“æˆåŠŸç‡": 0.96, "æ­©è¡Œå›å¾©ç‡": 0.82},
                    "80ä»£ä»¥ä¸Š": {"ç—‡ä¾‹æ•°": 46, "æ‰‹è¡“æˆåŠŸç‡": 0.93, "æ­©è¡Œå›å¾©ç‡": 0.74}
                },
                "å¹³å‡æ‰‹è¡“å¾…æ©Ÿæ—¥æ•°": 2.3,
                "å¹³å‡åœ¨é™¢æ—¥æ•°": 28.5
            }
        }
    
    def _add_ehr_integration_note(self, response: str) -> str:
        """é›»å­ã‚«ãƒ«ãƒ†é€£æºå‰ææ©Ÿèƒ½ã®æ³¨é‡ˆã‚’è¿½åŠ """
        note = """
        
âš ï¸ **ã“ã®æ©Ÿèƒ½ã¯é›»å­ã‚«ãƒ«ãƒ†ã‚·ã‚¹ãƒ†ãƒ ã¨ã®é€£æºãŒå‰æã®å›ç­”ã§ã™ã€‚**
ğŸ“‹ å®Ÿè£…æ™‚ã«ã¯ä»¥ä¸‹ãŒå¿…è¦: 
â€¢ é›»å­ã‚«ãƒ«ãƒ†APIé€£æº
â€¢ DPCãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é€£æº
â€¢ è¨ºç™‚ç§‘åˆ¥ç—‡ä¾‹ç™»éŒ²ã‚·ã‚¹ãƒ†ãƒ 
â€¢ æ²»ç™‚æˆç¸¾è©•ä¾¡ã‚·ã‚¹ãƒ†ãƒ 
â€¢ åŒ»ç™‚å®‰å…¨ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ é€£æº"""
        
        return response + note
    
    def analyze_treatment_outcomes(self, query: str) -> str:
        """æ²»ç™‚æˆç¸¾åˆ†æ"""
        
        # è³ªå•ã‹ã‚‰ç–¾æ‚£ã¨å¹´ä»£ã‚’æŠ½å‡º
        disease = None
        age_group = None
        
        if "å¿ƒç­‹æ¢—å¡" in query:
            disease = "æ€¥æ€§å¿ƒç­‹æ¢—å¡"
        elif "è„³æ¢—å¡" in query:
            disease = "è„³æ¢—å¡"
        elif "éª¨æŠ˜" in query or "å¤§è…¿éª¨" in query:
            disease = "å¤§è…¿éª¨éª¨æŠ˜"
            
        if "60ä»£" in query or "60æ­³ä»£" in query:
            age_group = "60ä»£"
        elif "70ä»£" in query or "70æ­³ä»£" in query:
            age_group = "70ä»£"
        elif "80ä»£" in query or "80æ­³ä»£" in query or "80æ­³ä»¥ä¸Š" in query:
            age_group = "80ä»£ä»¥ä¸Š"
        elif "50ä»£" in query or "50æ­³ä»£" in query:
            age_group = "50ä»£"
            
        # è©²å½“ãƒ‡ãƒ¼ã‚¿ã®æŠ½å‡º
        analysis_data = {}
        if disease and disease in self.clinical_data:
            disease_data = self.clinical_data[disease]
            analysis_data[disease] = disease_data
            
            # å¹´é½¢ç¾¤ãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚Œã°ãã®è©³ç´°ã‚‚è¿½åŠ 
            if age_group and age_group in disease_data.get("å¹´é½¢åˆ¥", {}):
                analysis_data["æŒ‡å®šå¹´é½¢ç¾¤è©³ç´°"] = disease_data["å¹´é½¢åˆ¥"][age_group]
        
        # å…¨ç–¾æ‚£ã®æ¦‚è¦ï¼ˆç–¾æ‚£ãŒç‰¹å®šã§ããªã„å ´åˆï¼‰
        if not disease:
            analysis_data = {
                "å…¨ç–¾æ‚£æ¦‚è¦": {
                    "æ€¥æ€§å¿ƒç­‹æ¢—å¡": f"å¹´é–“{self.clinical_data['æ€¥æ€§å¿ƒç­‹æ¢—å¡']['å¹´é–“ç—‡ä¾‹æ•°']}ä¾‹",
                    "è„³æ¢—å¡": f"å¹´é–“{self.clinical_data['è„³æ¢—å¡']['å¹´é–“ç—‡ä¾‹æ•°']}ä¾‹", 
                    "å¤§è…¿éª¨éª¨æŠ˜": f"å¹´é–“{self.clinical_data['å¤§è…¿éª¨éª¨æŠ˜']['å¹´é–“ç—‡ä¾‹æ•°']}ä¾‹"
                }
            }
        
        prompt = f"""
        ã‚ãªãŸã¯Aç—…é™¢ã®åŒ»ç™‚çµ±è¨ˆåˆ†ææ‹…å½“è€…ã§ã™ã€‚ä»¥ä¸‹ã®è¨ºç™‚å®Ÿç¸¾ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€æ²»ç™‚æˆç¸¾ã«ã¤ã„ã¦åˆ†æãƒ»å ±å‘Šã—ã¦ãã ã•ã„ã€‚
        
        # åˆ†æå¯¾è±¡ãƒ‡ãƒ¼ã‚¿
        {analysis_data}
        
        # è³ªå•
        {query}
        
        # å›ç­”å½¢å¼
        1. **è©²å½“ç—‡ä¾‹ã®æ¦‚è¦**: ç—‡ä¾‹æ•°ã¨åŸºæœ¬çµ±è¨ˆ
        2. **æ²»ç™‚æˆç¸¾**: æˆåŠŸç‡ã€åˆä½µç—‡ç‡ã€æ­»äº¡ç‡ç­‰ã®ä¸»è¦æŒ‡æ¨™
        3. **ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯æ¯”è¼ƒ**: å…¨å›½å¹³å‡ãƒ»åœ°åŸŸå¹³å‡ã¨ã®æ¯”è¼ƒï¼ˆæ¨å®šå€¤ï¼‰
        4. **èª²é¡Œã¨æ”¹å–„ç‚¹**: æˆç¸¾å‘ä¸Šã®ãŸã‚ã®å…·ä½“çš„ææ¡ˆ
        5. **ä»Šå¾Œã®å–ã‚Šçµ„ã¿**: åŒ»ç™‚ã®è³ªå‘ä¸Šã«å‘ã‘ãŸè¡Œå‹•è¨ˆç”»
        
        åŒ»ç™‚ã®è³ªå‘ä¸Šã¨æ‚£è€…å®‰å…¨ã«è³‡ã™ã‚‹å®Ÿç”¨çš„ãªåˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
        æ•°å€¤ã¯å®Ÿéš›ã®è‡¨åºŠç¾å ´ã§æ´»ç”¨ã§ãã‚‹ã‚ˆã†å…·ä½“çš„ã«ç¤ºã—ã¦ãã ã•ã„ã€‚
        """
        
        try:
            response = self.model.invoke(prompt)
            return self._add_ehr_integration_note(response.content)
        except Exception as e:
            return f"æ²»ç™‚æˆç¸¾åˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}"
    
    def analyze_case_statistics(self, query: str) -> str:
        """ç—‡ä¾‹çµ±è¨ˆåˆ†æ"""
        
        # æœˆåˆ¥ç—‡ä¾‹æ•°ã®æ¨¡æ“¬ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆ
        monthly_cases = {}
        for i in range(12):
            month = f"2024-{(i+1):02d}"
            monthly_cases[month] = {
                "æ€¥æ€§å¿ƒç­‹æ¢—å¡": random.randint(2, 6),
                "è„³æ¢—å¡": random.randint(3, 8),
                "å¤§è…¿éª¨éª¨æŠ˜": random.randint(4, 10)
            }
        
        prompt = f"""
        ã‚ãªãŸã¯Aç—…é™¢ã®è¨ºç™‚çµ±è¨ˆæ‹…å½“è€…ã§ã™ã€‚ä»¥ä¸‹ã®ãƒ‡ãƒ¼ã‚¿ã‚’åŸºã«ã€ç—‡ä¾‹çµ±è¨ˆã«ã¤ã„ã¦åˆ†æã—ã¦ãã ã•ã„ã€‚
        
        # å¹´é–“ç—‡ä¾‹çµ±è¨ˆ
        {self.clinical_data}
        
        # æœˆåˆ¥ç—‡ä¾‹æ¨ç§»ï¼ˆç›´è¿‘12ãƒ¶æœˆï¼‰
        {monthly_cases}
        
        # è³ªå•
        {query}
        
        # å›ç­”å½¢å¼
        1. **ç—‡ä¾‹æ•°å‹•å‘**: ä¸»è¦ç–¾æ‚£ã®ç—‡ä¾‹æ•°ã¨æ¨ç§»
        2. **å­£ç¯€æ€§åˆ†æ**: æœˆåˆ¥ãƒ»å­£ç¯€åˆ¥ã®ç‰¹å¾´
        3. **è¨ºç™‚è² è·**: ç—…åºŠç¨¼åƒã¸ã®å½±éŸ¿ã¨åŒ»å¸«è² è·
        4. **åœ°åŸŸåŒ»ç™‚ã¸ã®è²¢çŒ®**: åŒ»ç™‚åœå†…ã§ã®å½¹å‰²
        5. **è¨ºç™‚ä½“åˆ¶å¼·åŒ–**: ç—‡ä¾‹æ•°å¢—åŠ ã¸ã®å¯¾å¿œç­–
        
        åœ°åŸŸã®ä¸­æ ¸ç—…é™¢ã¨ã—ã¦ã®å½¹å‰²ã‚’è¸ã¾ãˆãŸå®Ÿè·µçš„ãªåˆ†æã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
        """
        
        try:
            response = self.model.invoke(prompt)
            return self._add_ehr_integration_note(response.content)
        except Exception as e:
            return f"ç—‡ä¾‹çµ±è¨ˆåˆ†æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: {e}"
    
    def query_clinical_analysis(self, query: str) -> str:
        """è¨ºç™‚åˆ†æã®ãƒ¡ã‚¤ãƒ³ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ"""
        query_lower = query.lower()
        
        # ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«ã‚ˆã‚‹æ©Ÿèƒ½æŒ¯ã‚Šåˆ†ã‘
        if any(keyword in query_lower for keyword in ["æ²»ç™‚æˆç¸¾", "æˆåŠŸç‡", "æ­»äº¡ç‡", "åˆä½µç—‡", "æ²»ç™‚çµæœ"]):
            return self.analyze_treatment_outcomes(query)
        elif any(keyword in query_lower for keyword in ["ç—‡ä¾‹æ•°", "çµ±è¨ˆ", "æ¨ç§»", "å‹•å‘"]):
            return self.analyze_case_statistics(query)
        else:
            # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ²»ç™‚æˆç¸¾åˆ†æ
            return self.analyze_treatment_outcomes(query)