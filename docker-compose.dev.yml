# docker-compose.dev.yml - é–‹ç™ºç’°å¢ƒç”¨
# é˜ªå—ãƒ“ã‚¸ãƒã‚¹ãƒã‚·ãƒ³ AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆï¼ˆé–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ï¼‰

version: '3.8'

services:
  # é–‹ç™ºç”¨AIã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ
  ai-agent-dev:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: hbm-ai-agent-dev
    restart: "no"  # é–‹ç™ºæ™‚ã¯è‡ªå‹•å†èµ·å‹•ãªã—
    
    # ç’°å¢ƒå¤‰æ•°ï¼ˆé–‹ç™ºç”¨ï¼‰
    environment:
      - PYTHONPATH=/app
      - PYTHONUNBUFFERED=1
      - DEVELOPMENT=true
      - DEBUG=true
    
    env_file:
      - .env  # é–‹ç™ºç”¨.envãƒ•ã‚¡ã‚¤ãƒ«
    
    # ãƒãƒ¼ãƒˆè¨­å®šï¼ˆç›´æ¥å…¬é–‹ï¼‰
    ports:
      - "8000:8000"
    
    # ãƒœãƒªãƒ¥ãƒ¼ãƒ ãƒã‚¦ãƒ³ãƒˆï¼ˆé–‹ç™ºç”¨ï¼‰
    volumes:
      # ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚¦ãƒ³ãƒˆï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰å¯¾å¿œï¼‰
      - ./src:/app/src
      - ./setup_vector_db.py:/app/setup_vector_db.py
      - ./requirements.txt:/app/requirements.txt
      
      # ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«
      - ./faiss_index_office:/app/faiss_index_office
      - ./faiss_index_sales:/app/faiss_index_sales
      - ./faiss_index_procedures:/app/faiss_index_procedures
      - ./data:/app/data
      - ./src/data:/app/src/data
      
      # ãƒ­ã‚°ã¨ãƒ†ã‚¹ãƒˆçµæœ
      - ./logs:/app/logs
      - ./test_results:/app/test_results
    
    # é–‹ç™ºç”¨ã‚³ãƒãƒ³ãƒ‰ï¼ˆãƒ›ãƒƒãƒˆãƒªãƒ­ãƒ¼ãƒ‰ï¼‰
    command: >
      sh -c "
        echo 'ğŸ”§ é–‹ç™ºãƒ¢ãƒ¼ãƒ‰ã§èµ·å‹•ä¸­...' &&
        pip install --no-cache-dir uvicorn[standard] &&
        uvicorn src.main:app --host 0.0.0.0 --port 8000 --reload --reload-dir src
      "
    
    # ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
    networks:
      - dev-network

  # é–‹ç™ºç”¨ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†
  db-manager:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: hbm-db-manager
    restart: "no"
    
    env_file:
      - .env
    
    volumes:
      - ./:/app/project
      - ./faiss_index_office:/app/faiss_index_office
      - ./faiss_index_sales:/app/faiss_index_sales
      - ./faiss_index_procedures:/app/faiss_index_procedures
      - ./data:/app/data
      - ./src/data:/app/src/data
    
    # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ç”¨ã‚³ãƒãƒ³ãƒ‰
    command: >
      sh -c "
        echo 'ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç®¡ç†ã‚³ãƒ³ãƒ†ãƒŠèµ·å‹•' &&
        echo 'åˆ©ç”¨å¯èƒ½ãªã‚³ãƒãƒ³ãƒ‰:' &&
        echo '  - python setup_vector_db.py (DBå†æ§‹ç¯‰)' &&
        echo '  - python debug_database.py (DBè¨ºæ–­)' &&
        tail -f /dev/null
      "
    
    networks:
      - dev-network

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç’°å¢ƒ
  test-runner:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    container_name: hbm-test-runner
    restart: "no"
    
    env_file:
      - .env
    
    volumes:
      - ./:/app/project
      - ./test_results:/app/test_results
    
    # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œç”¨ã‚³ãƒãƒ³ãƒ‰
    command: >
      sh -c "
        echo 'ğŸ§ª ãƒ†ã‚¹ãƒˆç’°å¢ƒæº–å‚™ä¸­...' &&
        pip install --no-cache-dir pytest pytest-asyncio &&
        echo 'ãƒ†ã‚¹ãƒˆå®Ÿè¡Œå¯èƒ½ã€‚ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’ä½¿ç”¨:' &&
        echo '  docker-compose -f docker-compose.dev.yml exec test-runner pytest' &&
        echo '  docker-compose -f docker-compose.dev.yml exec test-runner python test_*.py' &&
        tail -f /dev/null
      "
    
    networks:
      - dev-network

# é–‹ç™ºç”¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯
networks:
  dev-network:
    driver: bridge